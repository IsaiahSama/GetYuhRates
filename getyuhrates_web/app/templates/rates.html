{% extends "base.html" %}

{% block title %}Get Rates - GetYuhRates{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <h2><i class="bi bi-graph-up"></i> Get Currency Exchange Rates</h2>
        <p class="text-muted">Retrieve live exchange rates from the CurrencyLayer API</p>
    </div>
</div>

<div class="row mt-3">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Request Parameters</h5>
            </div>
            <div class="card-body">
                <form id="ratesForm" method="POST" action="/rates/fetch">
                    <div class="mb-3">
                        <label for="source" class="form-label">
                            Source Currencies <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="source" name="source" multiple required size="5">
                            {% for currency in available_currencies %}
                            <option value="{{ currency }}" {% if currency in default_source %}selected{% endif %}>
                                {{ currency }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Hold Ctrl/Cmd to select multiple currencies</div>
                    </div>

                    <div class="mb-3">
                        <label for="currencies" class="form-label">
                            Target Currencies <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="currencies" name="currencies" multiple required size="5">
                            {% for currency in available_currencies %}
                            <option value="{{ currency }}" {% if currency in default_currencies %}selected{% endif %}>
                                {{ currency }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Hold Ctrl/Cmd to select multiple currencies</div>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="save_to_file" name="save_to_file" value="true">
                        <label class="form-check-label" for="save_to_file">
                            Save results to CSV file
                        </label>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> Get Rates
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-body bg-light">
                <h6><i class="bi bi-info-circle"></i> Tips</h6>
                <ul class="small mb-0">
                    <li>Select one or more source currencies to convert from</li>
                    <li>Select one or more target currencies to convert to</li>
                    <li>Each source currency will be converted to all target currencies</li>
                    <li>Same-currency conversions (e.g., USD to USD) will return a rate of 1.0</li>
                    <li>Check "Save to file" to store results as CSV in the reports directory</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card" id="resultsCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">Results</h5>
            </div>
            <div class="card-body">
                <div id="resultsContainer"></div>
            </div>
        </div>

        <div class="card" id="loadingCard" style="display: none;">
            <div class="card-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Fetching exchange rates...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('ratesForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const loadingCard = document.getElementById('loadingCard');
    const resultsCard = document.getElementById('resultsCard');
    const resultsContainer = document.getElementById('resultsContainer');

    // Show loading, hide results
    loadingCard.style.display = 'block';
    resultsCard.style.display = 'none';

    // Get form data
    const formData = new FormData(this);
    const source = formData.getAll('source');
    const currencies = formData.getAll('currencies');
    const save_to_file = formData.get('save_to_file') === 'true';

    try {
        const response = await fetch('/rates/fetch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                source: source,
                currencies: currencies,
                save_to_file: save_to_file
            })
        });

        const data = await response.json();

        // Hide loading
        loadingCard.style.display = 'none';

        if (response.ok) {
            // Display results
            let html = '';

            data.forEach(result => {
                if (result.success) {
                    html += `
                        <div class="alert alert-success">
                            <h6><i class="bi bi-check-circle"></i> ${result.source}</h6>
                            <div class="table-responsive mt-2">
                                <table class="table table-sm table-bordered mb-0">
                                    <thead>
                                        <tr>
                                            <th>Currency Pair</th>
                                            <th>Rate</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;

                    for (const [pair, rate] of Object.entries(result.rates)) {
                        html += `
                            <tr>
                                <td><strong>${pair}</strong></td>
                                <td>${rate.toFixed(6)}</td>
                            </tr>
                        `;
                    }

                    html += `
                                    </tbody>
                                </table>
                            </div>
                    `;

                    if (result.file_location) {
                        html += `<p class="mt-2 mb-0"><small><i class="bi bi-file-earmark-check"></i> Saved to: ${result.file_location}</small></p>`;
                    }

                    html += `</div>`;
                } else {
                    html += `
                        <div class="alert alert-danger">
                            <h6><i class="bi bi-x-circle"></i> ${result.source}</h6>
                            <p class="mb-0">Error: ${result.reason || 'Unknown error'}</p>
                        </div>
                    `;
                }
            });

            resultsContainer.innerHTML = html;
            resultsCard.style.display = 'block';

            showAlert('Exchange rates retrieved successfully!', 'success');
        } else {
            showAlert(data.detail || 'Failed to retrieve exchange rates', 'danger');
        }
    } catch (error) {
        loadingCard.style.display = 'none';
        showAlert('Error: ' + error.message, 'danger');
    }
});
</script>
{% endblock %}
